<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>3.6. TimestampService</title><link rel="stylesheet" type="text/css" href="stylesheet.css"/><meta name="generator" content="DocBook XSL Stylesheets V1.76.1"/><link rel="home" href="index.html" title="The Foglight Agent Manager Developer's Kit"/><link rel="up" href="ch03.html" title="Chapter 3. Agent Services"/><link rel="prev" href="ch03s05.html" title="3.5. UnitService"/><link rel="next" href="ch03s07.html" title="3.7. UpstreamConnectionService"/><meta http-equiv="content-type" content="application/xhtml+xml; charset=utf-8"/></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">3.6. TimestampService</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="ch03s05.html"><img src="images/prev.png" alt="Prev"/></a> </td><th width="60%" align="center">Chapter 3. Agent Services</th><td width="20%" align="right"> <a accesskey="n" href="ch03s07.html"><img src="images/next.png" alt="Next"/></a></td></tr></table><hr/></div><img align="right" alt="[QUEST Logo]" src="images/quest_logo.gif"/><div class="section" title="3.6. TimestampService"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="agentservices-TimestampService"/>3.6. TimestampService</h2></div></div></div><div class="important" title="Important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.png"/></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>
                The accuracy of the corrected timestamps is substantially less precise
                than that provided by a <acronym class="acronym">NTP</acronym> client. If at all possible,
                the client's system clock should be managed using <acronym class="acronym">NTP</acronym> and the
                Timestamp service should be configured to return the trusted system time.
            </p></td></tr></table></div><p>
            If an agent needs to adjust timestamps that are not handled by the
            <code class="function">SpidDataSubmissionService</code>, it can access the
            <code class="function">TimestampService</code>
            to do this. The <code class="function">TimestampService</code> allows an agent to determine
            the time difference between the agent and the server (excluding time zones). It can also provide
            timestamps based on the corrected time and convert a client's local timestamp into
            one that matches the server's canonical time.
        </p><div class="tip" title="Tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"/></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>
                All timestamps in both the  <code class="function">TimestampService</code> and
                <code class="function">SpidDataSubmissionService</code> automatically account for timezone
                differences between the client and server machines. No extra steps are
                necessary when the client and server are in different timezones.
            </p></td></tr></table></div><div class="section" title="3.6.1. Using the TimestampService"><div class="titlepage"><div><div><h3 class="title"><a id="agentservices-TimestampService-usage"/>3.6.1. Using the TimestampService</h3></div></div></div><p>
                The <code class="function">TimestampService</code> is accessed through the standard
                service access mechanism:
                </p><pre class="programlisting"><strong class="hl-keyword">class</strong> AClass {
  <strong class="hl-keyword">public</strong> AClass(ServiceFactory factory) {
    TimestampService timestamp =
                         factory.getService(TimestampService.<strong class="hl-keyword">class</strong>);
  }
}</pre><p>
            </p><p>
                Once you have access to the <code class="function">TimestampService</code>, you can use it
                to:
                </p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>
                        Get the time difference between the client and the server, in milliseconds
                        </p><pre class="programlisting"><strong class="hl-keyword">long</strong> diff = timestamp.getApproxDiffToServer();</pre><p>
                    </p></li><li class="listitem"><p>
                        Get a timestamp that corresponds to the server's current time:
                        </p><pre class="programlisting">GregorianCalendar servertime =
       timestamp.getCorrectedTimestamp();</pre><p>
                    </p></li><li class="listitem"><p>
                        Adjust a local timestamp to match the server's canonical time:
                        </p><pre class="programlisting">GregorianCalendar correctedtime =
       timestamp.getCorrectedTimestamp(System.currentTimeMillis());</pre><p>
                    </p></li></ol></div><p>
            </p></div><div class="section" title="3.6.2. How Time Differences Are Computed"><div class="titlepage"><div><div><h3 class="title"><a id="agentservices-TimestampService-algorithm"/>3.6.2. How Time Differences Are Computed</h3></div></div></div><p>
                The <code class="function">TimestampService</code> uses the following method to determine
                the time difference between the client and the server.
            </p><p>
                The following diagram depicts the transmission of a single message envelope
                from the client to the server, and the server processing the envelope and
                subsequently returning a response:
            </p><pre class="programlisting">
  client             <a id="client_start"/><img src="images/callouts/1.png" alt="1" border="0"/> client start
        \
         \           <a id="latency_up"/><img src="images/callouts/2.png" alt="2" border="0"/> latency
          \
          server     <a id="server_start"/><img src="images/callouts/3.png" alt="3" border="0"/> server start
             |
             |       <a id="server_work"/><img src="images/callouts/4.png" alt="4" border="0"/> server processing time
             |
          server     <a id="server_end"/><img src="images/callouts/5.png" alt="5" border="0"/> server end
         /
        /            <a id="latency_down"/><img src="images/callouts/6.png" alt="6" border="0"/> latency
       /
  client             <a id="client_end"/><img src="images/callouts/7.png" alt="7" border="0"/> client end

             (client_end - client start) - (server end - server start)
  latency =  ---------------------------------------------------------
                                         2

  time diff = client start - ( server start - latency )</pre><p>
            </p><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#client_start"><img src="images/callouts/1.png" alt="1" border="0"/></a> </p></td><td valign="top" align="left"><p>
                        The client transmits its upstream message envelope to the server.
                    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#latency_up"><img src="images/callouts/2.png" alt="2" border="0"/></a> </p></td><td valign="top" align="left"><p>
                        There is network and message-processing latency between the client and the
                        server for upstream messages.
                    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#server_start"><img src="images/callouts/3.png" alt="3" border="0"/></a> </p></td><td valign="top" align="left"><p>
                        The server receives the upstream message from the client and starts
                        to process it.
                    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#server_work"><img src="images/callouts/4.png" alt="4" border="0"/></a> </p></td><td valign="top" align="left"><p>
                        The server spends an unspecified amount of time processing the
                        envelope from the client and generating a response.
                    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#server_end"><img src="images/callouts/5.png" alt="5" border="0"/></a> </p></td><td valign="top" align="left"><p>
                        The server hand generates a downstream response envelope for the
                        client and transmits it.
                    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#latency_down"><img src="images/callouts/6.png" alt="6" border="0"/></a> </p></td><td valign="top" align="left"><p>
                        There is network and message-processing latency between the server and the
                        client for downstream messages.
                    </p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#client_end"><img src="images/callouts/7.png" alt="7" border="0"/></a> </p></td><td valign="top" align="left"><p>
                        The client receives the server's response envelope and begins processing it.
                    </p></td></tr></table></div><p>
            </p></div></div><div class="navfooter"><hr/><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="ch03s05.html"><img src="images/prev.png" alt="Prev"/></a> </td><td width="20%" align="center"><a accesskey="u" href="ch03.html"><img src="images/up.png" alt="Up"/></a></td><td width="40%" align="right"> <a accesskey="n" href="ch03s07.html"><img src="images/next.png" alt="Next"/></a></td></tr><tr><td width="40%" align="left" valign="top">3.5. UnitService </td><td width="20%" align="center"><a accesskey="h" href="index.html"><img src="images/home.png" alt="Home"/></a></td><td width="40%" align="right" valign="top"> 3.7. UpstreamConnectionService</td></tr></table></div></body></html>